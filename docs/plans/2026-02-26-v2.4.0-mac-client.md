# v2.4.0 Mac Client — Three Mode UI Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build the full Tauri 2.x Mac desktop client with Full, Copilot, and Ninja interaction modes per the locked v2.4.0 PRD spec.

**Architecture:** Two Vite entries (main + ninja), Vue 3 + Pinia, Tauri 2.x with 4 plugins, interface-contract-first parallel execution across 5 phases.

**Tech Stack:** Tauri 2.x, Vue 3 + Composition API, Pinia, Vite 5, TypeScript, Vitest, @vue/test-utils, @tauri-apps/api v2, toml crate

**Spec reference:** `day1-doctor-prd/03-design/MacClient_UIUX_Iteration.md`
**Design doc:** `docs/plans/2026-02-26-v2.4.0-mac-client-design.md`
**Working directory for all tasks:** `crates/desktop/` (relative to `d1-doctor-app/`)

---

## Phase 1 — Scaffold + Contracts

### Task 1: Remove old Tauri v1 config and prepare directories

**Files:**
- Delete: `crates/desktop/tauri.conf.json` (v1 format, wrong location)
- Create: `crates/desktop/src-tauri/` structure
- Create: `crates/desktop/src/` structure

**Step 1: Remove old v1 config**

```bash
cd /Users/wenqingyu/Documents/workspace/day1-doctor/d1-doctor-app
rm crates/desktop/tauri.conf.json
rm crates/desktop/src/.gitkeep
rm crates/desktop/src-tauri/.gitkeep
```

**Step 2: Create directory structure**

```bash
mkdir -p crates/desktop/src-tauri/src/commands
mkdir -p crates/desktop/src-tauri/capabilities
mkdir -p crates/desktop/src/shared/styles
mkdir -p crates/desktop/src/shared/components
mkdir -p crates/desktop/src/shared/stores
mkdir -p crates/desktop/src/shared/composables
mkdir -p crates/desktop/src/modes/full
mkdir -p crates/desktop/src/modes/copilot
mkdir -p crates/desktop/src/modes/ninja
```

**Step 3: Commit**

```bash
git add -A crates/desktop/
git commit -m "chore(desktop): remove Tauri v1 stub, prepare v2 directory structure"
```

---

### Task 2: Create src-tauri/Cargo.toml with Tauri 2 + all 4 plugins

**Files:**
- Create: `crates/desktop/src-tauri/Cargo.toml`

**Step 1: Write Cargo.toml**

```toml
[package]
name = "d1-doctor-desktop"
version = "0.1.0"
edition = "2021"

[lib]
name = "d1_doctor_desktop_lib"
crate-type = ["staticlib", "cdylib", "rlib"]

[build-dependencies]
tauri-build = { version = "2", features = [] }

[dependencies]
tauri = { version = "2", features = [] }
tauri-plugin-global-shortcut = "2"
tauri-plugin-fs = "2"
tauri-plugin-window-state = "2"
tauri-plugin-single-instance = "2"
serde = { version = "1", features = ["derive"] }
serde_json = "1"
toml = "0.8"

[profile.release]
panic = "abort"
codegen-units = 1
lto = true
opt-level = "s"
strip = true
```

**Step 2: Create build.rs**

```rust
// crates/desktop/src-tauri/build.rs
fn main() {
    tauri_build::build()
}
```

**Step 3: Commit**

```bash
git add crates/desktop/src-tauri/Cargo.toml crates/desktop/src-tauri/build.rs
git commit -m "chore(desktop): add Tauri v2 Cargo.toml with all 4 plugins"
```

---

### Task 3: Create tauri.conf.json (Tauri v2 format, two windows)

**Files:**
- Create: `crates/desktop/src-tauri/tauri.conf.json`

**Step 1: Write tauri.conf.json**

```json
{
  "$schema": "https://schema.tauri.app/config/v2",
  "productName": "Day 1 Doctor",
  "version": "2.4.0",
  "identifier": "com.day1doctor.app",
  "build": {
    "beforeDevCommand": "npm run dev",
    "devUrl": "http://localhost:5173",
    "beforeBuildCommand": "npm run build",
    "frontendDist": "../dist"
  },
  "app": {
    "windows": [
      {
        "label": "main",
        "title": "Day 1 Doctor",
        "url": "index.html",
        "width": 1200,
        "height": 760,
        "minWidth": 900,
        "minHeight": 600,
        "decorations": false,
        "transparent": true,
        "resizable": true,
        "visible": true
      },
      {
        "label": "ninja-bar",
        "title": "Day 1 Doctor — Ninja",
        "url": "ninja.html",
        "width": 680,
        "height": 64,
        "decorations": false,
        "transparent": true,
        "alwaysOnTop": true,
        "resizable": false,
        "skipTaskbar": true,
        "visible": false
      }
    ],
    "security": {
      "csp": "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'"
    }
  },
  "bundle": {
    "active": true,
    "targets": "all",
    "icon": []
  }
}
```

**Step 2: Create capabilities/default.json**

```json
{
  "$schema": "https://schema.tauri.app/config/v2/capabilities.json",
  "identifier": "default",
  "description": "Default capability for Day 1 Doctor",
  "windows": ["main", "ninja-bar"],
  "permissions": [
    "core:default",
    "core:window:allow-close",
    "core:window:allow-minimize",
    "core:window:allow-maximize",
    "core:window:allow-set-size",
    "core:window:allow-set-position",
    "core:window:allow-show",
    "core:window:allow-hide",
    "core:window:allow-is-visible",
    "fs:allow-read-text-file",
    "fs:allow-write-text-file",
    "fs:allow-create",
    "fs:allow-mkdir",
    "global-shortcut:allow-register",
    "global-shortcut:allow-unregister",
    "window-state:allow-save-window-state",
    "window-state:allow-restore-state"
  ]
}
```

**Step 3: Create entitlements.plist**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.automation.apple-events</key>
  <true/>
</dict>
</plist>
```

**Step 4: Commit**

```bash
git add crates/desktop/src-tauri/tauri.conf.json crates/desktop/src-tauri/capabilities/ crates/desktop/src-tauri/entitlements.plist
git commit -m "chore(desktop): add Tauri v2 window config (main + ninja-bar) and capabilities"
```

---

### Task 4: Create Rust main.rs, lib.rs, and command stubs

**Files:**
- Create: `crates/desktop/src-tauri/src/main.rs`
- Create: `crates/desktop/src-tauri/src/lib.rs`
- Create: `crates/desktop/src-tauri/src/commands/mod.rs`
- Create: `crates/desktop/src-tauri/src/commands/config.rs`
- Create: `crates/desktop/src-tauri/src/commands/window.rs`

**Step 1: Write main.rs**

```rust
// src-tauri/src/main.rs
#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]

fn main() {
    d1_doctor_desktop_lib::run();
}
```

**Step 2: Write lib.rs**

```rust
// src-tauri/src/lib.rs
mod commands;

use commands::{config, window};

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_global_shortcut::Builder::new().build())
        .plugin(tauri_plugin_fs::init())
        .plugin(tauri_plugin_window_state::Builder::default().build())
        .plugin(tauri_plugin_single_instance::init(|app, _args, _cwd| {
            // Focus main window on second launch attempt
            if let Some(window) = app.get_webview_window("main") {
                let _ = window.show();
                let _ = window.set_focus();
            }
        }))
        .invoke_handler(tauri::generate_handler![
            config::get_config,
            config::set_config,
            window::resize_window,
            window::position_window,
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

**Step 3: Write commands/mod.rs**

```rust
// src-tauri/src/commands/mod.rs
pub mod config;
pub mod window;
```

**Step 4: Write commands/config.rs (stub)**

```rust
// src-tauri/src/commands/config.rs
/// Get a config value from ~/.d1doctor/config.toml
/// Returns empty string if key not found
#[tauri::command]
pub async fn get_config(key: String) -> Result<String, String> {
    // Phase 2-B implements full config.toml r/w
    Ok(String::new())
}

/// Set a config value in ~/.d1doctor/config.toml
#[tauri::command]
pub async fn set_config(key: String, value: String) -> Result<(), String> {
    // Phase 2-B implements full config.toml r/w
    Ok(())
}
```

**Step 5: Write commands/window.rs (stub)**

```rust
// src-tauri/src/commands/window.rs
/// Resize the calling window
#[tauri::command]
pub async fn resize_window(
    window: tauri::Window,
    width: u32,
    height: u32,
) -> Result<(), String> {
    window
        .set_size(tauri::Size::Physical(tauri::PhysicalSize { width, height }))
        .map_err(|e| e.to_string())
}

/// Reposition the calling window
#[tauri::command]
pub async fn position_window(
    window: tauri::Window,
    x: i32,
    y: i32,
) -> Result<(), String> {
    window
        .set_position(tauri::Position::Physical(tauri::PhysicalPosition { x, y }))
        .map_err(|e| e.to_string())
}
```

**Step 6: Commit**

```bash
git add crates/desktop/src-tauri/src/
git commit -m "feat(desktop/rust): add Tauri v2 app entry, plugin init, command stubs"
```

---

### Task 5: Create package.json and vite.config.ts (multi-entry)

**Files:**
- Create: `crates/desktop/package.json`
- Create: `crates/desktop/vite.config.ts`
- Create: `crates/desktop/tsconfig.json`

**Step 1: Write package.json**

```json
{
  "name": "d1-doctor-desktop",
  "private": true,
  "version": "2.4.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc --noEmit && vite build",
    "preview": "vite preview",
    "tauri": "tauri",
    "test": "vitest run",
    "test:watch": "vitest"
  },
  "dependencies": {
    "@tauri-apps/api": "^2",
    "@tauri-apps/plugin-fs": "^2",
    "@tauri-apps/plugin-global-shortcut": "^2",
    "@tauri-apps/plugin-window-state": "^2",
    "pinia": "^2.1.7",
    "vue": "^3.4.0"
  },
  "devDependencies": {
    "@tauri-apps/cli": "^2",
    "@vitejs/plugin-vue": "^5.0.0",
    "@vue/test-utils": "^2.4.0",
    "jsdom": "^24.0.0",
    "typescript": "^5.3.0",
    "vite": "^5.0.0",
    "vitest": "^1.2.0",
    "vue-tsc": "^2.0.0"
  }
}
```

**Step 2: Write vite.config.ts**

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  clearScreen: false,
  server: {
    port: 5173,
    strictPort: true,
    watch: {
      ignored: ['**/src-tauri/**'],
    },
  },
  build: {
    target: ['es2021', 'chrome105', 'safari15'],
    minify: !process.env.TAURI_DEBUG ? 'esbuild' : false,
    sourcemap: !!process.env.TAURI_DEBUG,
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'src/index.html'),
        ninja: resolve(__dirname, 'src/ninja.html'),
      },
    },
    outDir: 'dist',
  },
  test: {
    environment: 'jsdom',
    globals: true,
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
    },
  },
})
```

**Step 3: Write tsconfig.json**

```json
{
  "compilerOptions": {
    "target": "ES2021",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2021", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.vue"],
  "exclude": ["node_modules", "src-tauri"]
}
```

**Step 4: Commit**

```bash
git add crates/desktop/package.json crates/desktop/vite.config.ts crates/desktop/tsconfig.json
git commit -m "chore(desktop): add package.json, vite multi-entry config, tsconfig"
```

---

### Task 6: Create src/shared/types.ts — complete type definitions

**Files:**
- Create: `crates/desktop/src/shared/types.ts`

**Step 1: Write types.ts (this is the contract file — never modify after Phase 1)**

```typescript
// src/shared/types.ts
// CONTRACT FILE — read-only after Phase 1 creates it.
// All downstream agents import from here, never modify.

export type UIMode = 'full' | 'copilot' | 'ninja'

export interface Message {
  id: string
  role: 'agent' | 'user'
  content: string
  timestamp: number
}

export interface Step {
  id: string
  label: string
  state: 'pending' | 'active' | 'done' | 'error'
  index: number
}

export interface Plan {
  steps: Step[]
  approved: boolean | null
}

export type AgentEventType =
  | 'plan_proposed'
  | 'step_started'
  | 'step_completed'
  | 'step_failed'
  | 'agent_message'
  | 'result_ready'
  | 'credits_updated'
  | 'permission_requested'

export interface AgentEvent {
  type: AgentEventType
  payload: Record<string, unknown>
}

export interface CreditInfo {
  current: number
  max: number
}

export interface Config {
  ui_mode: UIMode
  last_copilot_x: number
  last_copilot_y: number
  theme: 'dark'
}
```

**Step 2: Commit**

```bash
git add crates/desktop/src/shared/types.ts
git commit -m "feat(desktop): add shared types contract (UIMode, Message, Step, Plan, AgentEvent)"
```

---

### Task 7: Create CSS design tokens and animations

**Files:**
- Create: `crates/desktop/src/shared/styles/tokens.css`
- Create: `crates/desktop/src/shared/styles/animations.css`

**Step 1: Write tokens.css (exact values from spec §1.1)**

```css
/* src/shared/styles/tokens.css */
/* CONTRACT FILE — locked per spec §1.1. Never use hardcoded hex in component CSS. */
:root {
  /* Surfaces */
  --background: #050505;
  --card: #0D0D0D;
  --muted: #1F1F1F;
  --border: #242424;

  /* Accent / Orange */
  --primary: #F97316;
  --accent: #F97316;
  --accent-hover: #EA580C;
  --accent-glow: rgba(249, 115, 22, 0.25);
  --accent-soft: rgba(249, 115, 22, 0.08);
  --accent-border: rgba(249, 115, 22, 0.3);

  /* Text */
  --text-primary: #E5E5E5;
  --text-secondary: #A0A0A0;
  --text-muted: #878787;
  --text-disabled: #555555;

  /* Status */
  --success: #22C55E;
  --success-soft: rgba(34, 197, 94, 0.15);
  --warning: #F59E0B;
  --error: #EF4444;

  /* Border radius */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;

  /* Typography */
  --font-mono: 'Geist Mono', 'SF Mono', 'Fira Code', monospace;

  /* Surfaces with backdrop */
  --surface-title-bar: rgba(13, 13, 13, 0.82);
  --surface-sidebar: rgba(10, 10, 10, 0.78);
  --surface-chat: rgba(5, 5, 5, 0.75);
  --surface-utility: rgba(13, 13, 13, 0.78);
  --surface-copilot: rgba(10, 10, 10, 0.85);
  --surface-ninja-bar: rgba(5, 5, 5, 0.82);
  --surface-ninja-dropdown: rgba(5, 5, 5, 0.88);

  /* Traffic lights */
  --traffic-close: #FF5F57;
  --traffic-minimize: #FFBD2E;
  --traffic-maximize: #28C840;
}
```

**Step 2: Write animations.css (exact keyframes from spec §1.2)**

```css
/* src/shared/styles/animations.css */
/* CONTRACT FILE — locked per spec §1.2. */

@keyframes agentPulse {
  0%, 100% { box-shadow: 0 0 12px rgba(249, 115, 22, 0.15); }
  50%       { box-shadow: 0 0 20px rgba(249, 115, 22, 0.35); }
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Respect reduced motion — applies to entire app */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}
```

**Step 3: Commit**

```bash
git add crates/desktop/src/shared/styles/
git commit -m "feat(desktop): add CSS design token system and animation keyframes (spec §1.1, §1.2)"
```

---

### Task 8: Create stub Pinia store files

**Files:**
- Create: `crates/desktop/src/shared/stores/app.ts`
- Create: `crates/desktop/src/shared/stores/conversation.ts`
- Create: `crates/desktop/src/shared/stores/agent.ts`

**Step 1: Write stores/app.ts (stub)**

```typescript
// src/shared/stores/app.ts
// Phase 2-B implements the full body. Phase 1 provides the typed interface.
import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { UIMode } from '@/shared/types'

export const useAppStore = defineStore('app', () => {
  const uiMode = ref<UIMode>('full')

  async function switchMode(_mode: UIMode): Promise<void> {
    // Phase 2-B implements: write config, resize window, emit event
  }

  return { uiMode, switchMode }
})
```

**Step 2: Write stores/conversation.ts (stub)**

```typescript
// src/shared/stores/conversation.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { Message, Plan, Step } from '@/shared/types'

export const useConversationStore = defineStore('conversation', () => {
  const messages = ref<Message[]>([])
  const currentPlan = ref<Plan | null>(null)
  const scrollPinned = ref(true)

  function appendMessage(_msg: Message): void {
    // Phase 2-B implements
  }

  function setPlan(_plan: Plan): void {
    // Phase 2-B implements
  }

  function updateStep(_stepId: string, _state: Step['state']): void {
    // Phase 2-B implements
  }

  return { messages, currentPlan, scrollPinned, appendMessage, setPlan, updateStep }
})
```

**Step 3: Write stores/agent.ts (stub)**

```typescript
// src/shared/stores/agent.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { CreditInfo } from '@/shared/types'

export const useAgentStore = defineStore('agent', () => {
  const credits = ref<CreditInfo>({ current: 0, max: 100 })
  const activeAgents = ref<string[]>([])
  const connectionStatus = ref<'connected' | 'disconnected' | 'connecting'>('disconnected')

  function updateCredits(_info: CreditInfo): void {
    // Phase 2-B implements
  }

  return { credits, activeAgents, connectionStatus, updateCredits }
})
```

**Step 4: Commit**

```bash
git add crates/desktop/src/shared/stores/
git commit -m "feat(desktop): add Pinia store stubs (app, conversation, agent)"
```

---

### Task 9: Create stub composable files

**Files:**
- Create: `crates/desktop/src/shared/composables/useAgentEvents.ts`
- Create: `crates/desktop/src/shared/composables/useConfig.ts`

**Step 1: Write useAgentEvents.ts (stub)**

```typescript
// src/shared/composables/useAgentEvents.ts
// Phase 5 implements the full event dispatch logic.
import type { AgentEvent } from '@/shared/types'

export function useAgentEvents() {
  function startListening(): void {
    // Phase 5 implements: listen('agent_event', handler)
  }

  function stopListening(): void {
    // Phase 5 implements: unlisten()
  }

  return { startListening, stopListening }
}
```

**Step 2: Write useConfig.ts (stub)**

```typescript
// src/shared/composables/useConfig.ts
// Phase 2-B implements full config.toml r/w via Tauri invoke.
import type { Config } from '@/shared/types'

export function useConfig() {
  async function getConfig<K extends keyof Config>(key: K): Promise<Config[K] | null> {
    // Phase 2-B implements: invoke('get_config', { key })
    return null
  }

  async function setConfig<K extends keyof Config>(key: K, value: Config[K]): Promise<void> {
    // Phase 2-B implements: invoke('set_config', { key, value })
  }

  return { getConfig, setConfig }
}
```

**Step 3: Commit**

```bash
git add crates/desktop/src/shared/composables/
git commit -m "feat(desktop): add composable stubs (useAgentEvents, useConfig)"
```

---

### Task 10: Create stub shared component .vue files (8 components)

**Files:**
- Create: `crates/desktop/src/shared/components/AgentAvatar.vue`
- Create: `crates/desktop/src/shared/components/MessageBubble.vue`
- Create: `crates/desktop/src/shared/components/StepIndicator.vue`
- Create: `crates/desktop/src/shared/components/PlanCard.vue`
- Create: `crates/desktop/src/shared/components/ResultCard.vue`
- Create: `crates/desktop/src/shared/components/CreditBar.vue`
- Create: `crates/desktop/src/shared/components/PermissionBadge.vue`
- Create: `crates/desktop/src/shared/components/KbdShortcut.vue`

**Step 1: Create each stub. Example pattern for all 8:**

`AgentAvatar.vue`:
```vue
<template>
  <!-- Phase 2-A implements full visual -->
  <div class="agent-avatar" :class="{ active }">{{ agent.charAt(0).toUpperCase() }}</div>
</template>

<script setup lang="ts">
defineProps<{ agent: string; active: boolean }>()
</script>

<style scoped>
.agent-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--muted); display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-secondary); }
</style>
```

`MessageBubble.vue`:
```vue
<template>
  <div class="message-bubble" :class="role">
    <span>{{ content }}</span>
  </div>
</template>

<script setup lang="ts">
defineProps<{ role: 'agent' | 'user'; content: string; timestamp: number }>()
</script>

<style scoped>
.message-bubble { padding: 12px 16px; border-radius: var(--radius-md); font: 13px/1.6 var(--font-mono); color: var(--text-primary); }
.agent { border-left: 2px solid var(--accent); background: var(--card); }
.user { background: var(--muted); align-self: flex-end; }
</style>
```

`StepIndicator.vue`:
```vue
<template>
  <div class="step-indicator" :class="state">
    <div class="step-dot">{{ state === 'done' ? '✓' : index + 1 }}</div>
    <span class="step-label">{{ label }}</span>
  </div>
</template>

<script setup lang="ts">
import type { Step } from '@/shared/types'
defineProps<{ state: Step['state']; label: string; index: number }>()
</script>

<style scoped>
.step-indicator { display: flex; align-items: center; gap: 10px; }
.step-dot { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; }
.done .step-dot { border-color: var(--success); color: var(--success); background: var(--success-soft); }
.active .step-dot { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
.pending .step-dot { color: var(--text-disabled); }
.step-label { font: 13px/1 var(--font-mono); color: var(--text-secondary); }
</style>
```

`PlanCard.vue`:
```vue
<template>
  <div class="plan-card">
    <StepIndicator v-for="step in steps" :key="step.id" v-bind="step" />
    <div class="plan-actions">
      <button @click="onApprove">Approve</button>
      <button @click="onReject">Reject</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import type { Step } from '@/shared/types'
import StepIndicator from './StepIndicator.vue'
defineProps<{ steps: Step[]; onApprove: () => void; onReject: () => void }>()
</script>

<style scoped>
.plan-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; display: flex; flex-direction: column; gap: 8px; }
.plan-actions { display: flex; gap: 8px; margin-top: 8px; }
button { padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--muted); color: var(--text-primary); cursor: pointer; font: 12px var(--font-mono); }
button:first-child { border-color: var(--accent); color: var(--accent); }
</style>
```

`ResultCard.vue`:
```vue
<template>
  <div class="result-card">
    <div class="result-title">{{ title }}</div>
    <div class="result-detail">{{ detail }}</div>
    <pre v-if="code" class="result-code">{{ code }}</pre>
  </div>
</template>

<script setup lang="ts">
defineProps<{ title: string; detail: string; code?: string }>()
</script>

<style scoped>
.result-card { background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.25); border-radius: var(--radius-md); padding: 16px; }
.result-title { font: 700 13px var(--font-mono); color: var(--success); margin-bottom: 4px; }
.result-detail { font: 12px var(--font-mono); color: var(--text-secondary); }
.result-code { margin-top: 10px; background: var(--muted); padding: 10px; border-radius: var(--radius-sm); font: 11px var(--font-mono); color: var(--text-primary); overflow-x: auto; }
</style>
```

`CreditBar.vue`:
```vue
<template>
  <div class="credit-bar" :class="variant">
    <span class="label">Credits</span>
    <div class="bar-track"><div class="bar-fill" :style="{ width: pct + '%' }" /></div>
    <span class="value">{{ credits }}/{{ max }}</span>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
const props = defineProps<{ credits: number; max: number; variant: 'full' | 'mini' | 'dropdown' }>()
const pct = computed(() => Math.min(100, (props.credits / props.max) * 100))
</script>

<style scoped>
.credit-bar { display: flex; align-items: center; gap: 8px; font: 11px var(--font-mono); color: var(--text-muted); }
.bar-track { flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
.mini .label { display: none; }
</style>
```

`PermissionBadge.vue`:
```vue
<template>
  <div class="permission-badge" :class="state">{{ label }}</div>
</template>

<script setup lang="ts">
defineProps<{ state: 'allow' | 'ask' | 'deny'; label: string }>()
</script>

<style scoped>
.permission-badge { display: inline-flex; padding: 3px 8px; border-radius: var(--radius-sm); font: 11px var(--font-mono); }
.allow { background: var(--success-soft); color: var(--success); border: 1px solid rgba(34,197,94,0.25); }
.ask { background: rgba(245,158,11,0.1); color: var(--warning); border: 1px solid rgba(245,158,11,0.25); }
.deny { background: rgba(239,68,68,0.1); color: var(--error); border: 1px solid rgba(239,68,68,0.25); }
</style>
```

`KbdShortcut.vue`:
```vue
<template>
  <span class="kbd-shortcut">
    <kbd v-for="key in keys" :key="key" class="kbd-key">{{ key }}</kbd>
  </span>
</template>

<script setup lang="ts">
defineProps<{ keys: string[] }>()
</script>

<style scoped>
.kbd-shortcut { display: inline-flex; align-items: center; gap: 2px; }
.kbd-key { display: inline-flex; padding: 1px 5px; border-radius: 3px; background: var(--muted); border: 1px solid var(--border); font: 10px var(--font-mono); color: var(--text-secondary); }
</style>
```

**Step 2: Commit**

```bash
git add crates/desktop/src/shared/components/
git commit -m "feat(desktop): add 8 shared component stubs (typed props, minimal render)"
```

---

### Task 11: Create stub mode .vue files and HTML entry points

**Files:**
- Create: `crates/desktop/src/modes/full/FullMode.vue`
- Create: `crates/desktop/src/modes/full/TitleBar.vue`
- Create: `crates/desktop/src/modes/full/Sidebar.vue`
- Create: `crates/desktop/src/modes/full/ChatWorkspace.vue`
- Create: `crates/desktop/src/modes/full/UtilityPanel.vue`
- Create: `crates/desktop/src/modes/copilot/CopilotMode.vue`
- Create: `crates/desktop/src/modes/copilot/CopilotHeader.vue`
- Create: `crates/desktop/src/modes/copilot/SessionBar.vue`
- Create: `crates/desktop/src/modes/copilot/CopilotInput.vue`
- Create: `crates/desktop/src/modes/ninja/NinjaBar.vue`
- Create: `crates/desktop/src/modes/ninja/NinjaDropdown.vue`
- Create: `crates/desktop/src/modes/ninja/StepTimeline.vue`
- Create: `crates/desktop/src/App.vue`
- Create: `crates/desktop/src/NinjaApp.vue`
- Create: `crates/desktop/src/main.ts`
- Create: `crates/desktop/src/ninja.ts`
- Create: `crates/desktop/src/index.html`
- Create: `crates/desktop/src/ninja.html`

**Step 1: Mode stub pattern (all 12 mode components are minimal shells)**

`FullMode.vue` stub:
```vue
<template>
  <div class="full-mode">
    <TitleBar />
    <div class="main-content">
      <Sidebar />
      <ChatWorkspace />
      <UtilityPanel />
    </div>
  </div>
</template>

<script setup lang="ts">
import TitleBar from './TitleBar.vue'
import Sidebar from './Sidebar.vue'
import ChatWorkspace from './ChatWorkspace.vue'
import UtilityPanel from './UtilityPanel.vue'
</script>

<style scoped>
.full-mode { display: flex; flex-direction: column; height: 100vh; background: var(--background); }
.main-content { display: flex; flex: 1; overflow: hidden; }
</style>
```

Each of the other 11 mode components follows the same pattern: minimal `<template>` showing the component name, `<script setup lang="ts">` imports, and minimal scoped style.

**Step 2: Root App.vue**

```vue
<template>
  <FullMode v-if="appStore.uiMode === 'full'" />
  <CopilotMode v-else-if="appStore.uiMode === 'copilot'" />
</template>

<script setup lang="ts">
import { useAppStore } from '@/shared/stores/app'
import FullMode from '@/modes/full/FullMode.vue'
import CopilotMode from '@/modes/copilot/CopilotMode.vue'
const appStore = useAppStore()
</script>
```

**Step 3: NinjaApp.vue**

```vue
<template>
  <NinjaBar />
  <NinjaDropdown v-if="showDropdown" />
</template>

<script setup lang="ts">
import { ref } from 'vue'
import NinjaBar from '@/modes/ninja/NinjaBar.vue'
import NinjaDropdown from '@/modes/ninja/NinjaDropdown.vue'
const showDropdown = ref(false)
</script>
```

**Step 4: Entry points**

`main.ts`:
```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'
import './shared/styles/tokens.css'
import './shared/styles/animations.css'

const app = createApp(App)
app.use(createPinia())
app.mount('#app')
```

`ninja.ts`:
```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import NinjaApp from './NinjaApp.vue'
import './shared/styles/tokens.css'
import './shared/styles/animations.css'

const app = createApp(NinjaApp)
app.use(createPinia())
app.mount('#ninja-app')
```

`index.html`:
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Day 1 Doctor</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/main.ts"></script>
  </body>
</html>
```

`ninja.html`:
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Day 1 Doctor — Ninja</title>
  </head>
  <body style="background: transparent; margin: 0;">
    <div id="ninja-app"></div>
    <script type="module" src="/ninja.ts"></script>
  </body>
</html>
```

**Step 5: Commit**

```bash
git add crates/desktop/src/
git commit -m "feat(desktop): add all mode component stubs, App.vue shell, entry points"
```

---

### Task 12: Install dependencies and verify build succeeds

**Step 1: Install npm dependencies**

```bash
cd /Users/wenqingyu/Documents/workspace/day1-doctor/d1-doctor-app/crates/desktop
npm install
```

Expected: packages installed, no error.

**Step 2: Type-check**

```bash
npm run build
```

Expected: TypeScript compilation passes, Vite produces two bundles in `dist/`. Zero errors.

If errors occur:
- Import path errors: verify `@/` alias is correctly set in both tsconfig and vite.config.ts
- Vue SFC errors: ensure `@vitejs/plugin-vue` is in plugins
- Missing type errors: check all props are typed with `defineProps<...>()`

**Step 3: Commit** (only if build passes)

```bash
git add -A crates/desktop/
git commit -m "chore(desktop): Phase 1 complete — npm install, build verified (2 bundles)"
```

**Phase 1 exit gate:** `npm run build` produces `dist/main.js` and `dist/ninja.js` (or similar) with zero TypeScript errors.

---

## Phase 2-A — Shared Components (Full Implementation)

> **Ownership:** `src/shared/components/**` only. Do NOT modify stores or composables.
> **All 8 components** must be implemented per spec §1.4 using only CSS tokens (no hardcoded hex).

### Task 13: Implement AgentAvatar component

**File:** `crates/desktop/src/shared/components/AgentAvatar.vue`

**Spec:** 30×30, orange border, pulsing glow animation when `active`. Props: `agent: string`, `active: boolean`

**Step 1: Write test**

Create `crates/desktop/src/shared/components/__tests__/AgentAvatar.test.ts`:
```typescript
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'
import AgentAvatar from '../AgentAvatar.vue'

describe('AgentAvatar', () => {
  it('renders first letter of agent name', () => {
    const wrapper = mount(AgentAvatar, { props: { agent: 'Planner', active: false } })
    expect(wrapper.text()).toContain('P')
  })

  it('applies active class when active=true', () => {
    const wrapper = mount(AgentAvatar, { props: { agent: 'Executor', active: true } })
    expect(wrapper.classes()).toContain('active')
  })

  it('does not apply active class when active=false', () => {
    const wrapper = mount(AgentAvatar, { props: { agent: 'Executor', active: false } })
    expect(wrapper.classes()).not.toContain('active')
  })
})
```

**Step 2: Run tests to see them fail**

```bash
cd /Users/wenqingyu/Documents/workspace/day1-doctor/d1-doctor-app/crates/desktop
npm test -- AgentAvatar
```

**Step 3: Implement AgentAvatar.vue**

```vue
<template>
  <div class="agent-avatar" :class="{ active }">
    {{ agent.charAt(0).toUpperCase() }}
  </div>
</template>

<script setup lang="ts">
defineProps<{ agent: string; active: boolean }>()
</script>

<style scoped>
.agent-avatar {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: var(--muted);
  border: 1.5px solid var(--accent-border);
  display: flex;
  align-items: center;
  justify-content: center;
  font: 700 11px var(--font-mono);
  color: var(--accent);
  flex-shrink: 0;
  transition: box-shadow 0.2s;
}

.agent-avatar.active {
  animation: agentPulse 1.8s ease-in-out infinite;
  border-color: var(--accent);
}
</style>
```

**Step 4: Run tests to see them pass**

```bash
npm test -- AgentAvatar
```

Expected: 3/3 tests pass.

**Step 5: Commit**

```bash
git add src/shared/components/AgentAvatar.vue src/shared/components/__tests__/AgentAvatar.test.ts
git commit -m "feat(desktop/components): implement AgentAvatar (30x30, pulsing glow, active state)"
```

---

### Task 14: Implement MessageBubble component

**File:** `crates/desktop/src/shared/components/MessageBubble.vue`

**Spec:** Agent variant (orange left border, dark card bg). User variant (muted bg, right-aligned). Props: `role: 'agent' | 'user'`, `content: string`, `timestamp: number`

**Step 1: Write test**

```typescript
// __tests__/MessageBubble.test.ts
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'
import MessageBubble from '../MessageBubble.vue'

describe('MessageBubble', () => {
  it('renders content', () => {
    const wrapper = mount(MessageBubble, {
      props: { role: 'agent', content: 'Hello world', timestamp: 1000 }
    })
    expect(wrapper.text()).toContain('Hello world')
  })

  it('applies agent class for agent role', () => {
    const wrapper = mount(MessageBubble, {
      props: { role: 'agent', content: 'Hi', timestamp: 1000 }
    })
    expect(wrapper.classes()).toContain('agent')
  })

  it('applies user class for user role', () => {
    const wrapper = mount(MessageBubble, {
      props: { role: 'user', content: 'Hi', timestamp: 1000 }
    })
    expect(wrapper.classes()).toContain('user')
  })

  it('renders formatted timestamp', () => {
    const wrapper = mount(MessageBubble, {
      props: { role: 'agent', content: 'Hi', timestamp: 1706745600000 }
    })
    // Should render some time string
    expect(wrapper.html()).toBeTruthy()
  })
})
```

**Step 2: Run to see fail, then implement**

```vue
<template>
  <div class="message-bubble" :class="role">
    <div class="bubble-header" v-if="role === 'agent'">
      <span class="role-label">Day 1 Doctor</span>
      <span class="timestamp">{{ formattedTime }}</span>
    </div>
    <div class="bubble-content">{{ content }}</div>
    <div class="bubble-footer" v-if="role === 'user'">
      <span class="timestamp">{{ formattedTime }}</span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'

const props = defineProps<{ role: 'agent' | 'user'; content: string; timestamp: number }>()

const formattedTime = computed(() =>
  new Date(props.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
)
</script>

<style scoped>
.message-bubble {
  display: flex;
  flex-direction: column;
  max-width: 85%;
  padding: 12px 16px;
  border-radius: var(--radius-md);
  font: 13px/1.6 var(--font-mono);
  animation: fadeIn 0.15s ease;
}

.agent {
  align-self: flex-start;
  background: var(--card);
  border-left: 2px solid var(--accent);
  color: var(--text-primary);
}

.user {
  align-self: flex-end;
  background: var(--muted);
  color: var(--text-primary);
}

.bubble-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.role-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--accent);
}

.timestamp {
  font-size: 10px;
  color: var(--text-disabled);
}

.bubble-content {
  white-space: pre-wrap;
  word-break: break-word;
}

.bubble-footer {
  margin-top: 4px;
  display: flex;
  justify-content: flex-end;
}
</style>
```

**Step 3: Run tests, commit**

```bash
npm test -- MessageBubble
git add src/shared/components/MessageBubble.vue src/shared/components/__tests__/MessageBubble.test.ts
git commit -m "feat(desktop/components): implement MessageBubble (agent/user variants, timestamps)"
```

---

### Task 15: Implement StepIndicator, PlanCard, ResultCard

**Files:** `StepIndicator.vue`, `PlanCard.vue`, `ResultCard.vue`

For each component, follow the TDD pattern from Tasks 13-14:
1. Write test for the component
2. Run to confirm failure
3. Implement per spec
4. Run to confirm pass
5. Commit

**StepIndicator spec (§1.4):**
- Props: `state: 'pending' | 'active' | 'done' | 'error'`, `label: string`, `index: number`
- `done`: green fill dot with ✓, green text
- `active`: orange border dot + `agentPulse` animation
- `pending`: gray border dot
- `error`: red border dot

```vue
<template>
  <div class="step-item" :class="state">
    <div class="step-dot">
      <span v-if="state === 'done'">✓</span>
      <span v-else-if="state === 'error'">✕</span>
      <span v-else>{{ index + 1 }}</span>
    </div>
    <div class="step-content">
      <span class="step-label">{{ label }}</span>
    </div>
  </div>
</template>

<script setup lang="ts">
import type { Step } from '@/shared/types'
defineProps<{ state: Step['state']; label: string; index: number }>()
</script>

<style scoped>
.step-item { display: flex; align-items: flex-start; gap: 12px; padding: 8px 0; position: relative; }
.step-dot { width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-family: var(--font-mono); }
.done .step-dot { background: var(--success-soft); border: 1px solid var(--success); color: var(--success); }
.active .step-dot { background: var(--accent-soft); border: 1px solid var(--accent); color: var(--accent); animation: agentPulse 1.8s ease-in-out infinite; }
.pending .step-dot { background: transparent; border: 1px solid var(--text-disabled); color: var(--text-disabled); }
.error .step-dot { background: rgba(239,68,68,0.1); border: 1px solid var(--error); color: var(--error); }
.step-label { font: 13px/1.4 var(--font-mono); color: var(--text-secondary); }
.done .step-label { color: var(--text-muted); }
.active .step-label { color: var(--text-primary); }
</style>
```

**PlanCard spec (§1.4):**
- Props: `steps: Step[]`, `onApprove: () => void`, `onReject: () => void`
- Shows all steps as StepIndicator list
- Progress bar (filled orange based on done/total)
- Approve (orange border) and Reject (gray) buttons

**ResultCard spec (§1.4):**
- Props: `title: string`, `detail: string`, `code?: string`
- Green success styling (rgba(34,197,94,0.08) background)
- Optional code block if `code` provided

Write tests, implement, run tests, commit each.

```bash
git commit -m "feat(desktop/components): implement StepIndicator, PlanCard, ResultCard"
```

---

### Task 16: Implement CreditBar, PermissionBadge, KbdShortcut

**CreditBar spec:**
- Props: `credits: number`, `max: number`, `variant: 'full' | 'mini' | 'dropdown'`
- `full`: label + bar track + value + "Buy Credits" link
- `mini`: just bar + compact value (no label)
- `dropdown`: bar + value + credit estimate

**PermissionBadge spec:**
- Props: `state: 'allow' | 'ask' | 'deny'`, `label: string`
- `allow`: green bg + green text
- `ask`: amber bg + amber text
- `deny`: red bg + red text

**KbdShortcut spec:**
- Props: `keys: string[]` (e.g. `['⌘', '⇧', 'D']`)
- Renders each key as a kbd pill with monospace font

Write tests → implement → run tests → commit each.

```bash
git commit -m "feat(desktop/components): implement CreditBar (3 variants), PermissionBadge, KbdShortcut"
```

**Phase 2-A exit gate:** All 8 components render correctly. `npm test` passes all component tests.

---

## Phase 2-B — Stores + IPC + Rust Commands

> **Ownership:** `src/shared/stores/**`, `src/shared/composables/**`, `src-tauri/src/commands/**`
> Do NOT modify component files.

### Task 17: Implement config.rs — full config.toml r/w

**File:** `crates/desktop/src-tauri/src/commands/config.rs`

**Step 1: Write Rust unit test (in the same file)**

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::fs;
    use tempfile::tempdir;

    #[test]
    fn test_parse_config_value() {
        let toml = r#"ui_mode = "full""#;
        let parsed: toml::Value = toml.parse().unwrap();
        assert_eq!(
            parsed.get("ui_mode").and_then(|v| v.as_str()),
            Some("full")
        );
    }
}
```

**Step 2: Implement config.rs**

```rust
use std::fs;
use std::path::PathBuf;

fn config_path() -> Result<PathBuf, String> {
    let home = dirs::home_dir().ok_or("Cannot find home directory")?;
    let config_dir = home.join(".d1doctor");
    fs::create_dir_all(&config_dir).map_err(|e| e.to_string())?;
    Ok(config_dir.join("config.toml"))
}

fn read_config_table() -> Result<toml::value::Table, String> {
    let path = config_path()?;
    if !path.exists() {
        return Ok(toml::value::Table::new());
    }
    let content = fs::read_to_string(&path).map_err(|e| e.to_string())?;
    content.parse::<toml::Value>()
        .map_err(|e| e.to_string())?
        .as_table()
        .cloned()
        .ok_or("Config is not a TOML table".to_string())
}

#[tauri::command]
pub async fn get_config(key: String) -> Result<String, String> {
    let table = read_config_table()?;
    Ok(table.get(&key)
        .and_then(|v| v.as_str())
        .unwrap_or("")
        .to_string())
}

#[tauri::command]
pub async fn set_config(key: String, value: String) -> Result<(), String> {
    let path = config_path()?;
    let mut table = read_config_table()?;
    table.insert(key, toml::Value::String(value));
    let content = toml::to_string(&toml::Value::Table(table))
        .map_err(|e| e.to_string())?;
    fs::write(&path, content).map_err(|e| e.to_string())
}
```

Note: Add `dirs = "5"` to Cargo.toml dependencies.

**Step 3: Run Rust tests**

```bash
cd crates/desktop/src-tauri
cargo test
```

**Step 4: Commit**

```bash
git add src-tauri/src/commands/config.rs src-tauri/Cargo.toml
git commit -m "feat(desktop/rust): implement config.toml r/w (get_config, set_config)"
```

---

### Task 18: Implement Pinia stores (app.ts, conversation.ts, agent.ts)

**Files:** `src/shared/stores/app.ts`, `conversation.ts`, `agent.ts`

**Step 1: Write Vitest tests**

```typescript
// __tests__/stores.test.ts
import { setActivePinia, createPinia } from 'pinia'
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { useConversationStore } from '../conversation'
import { useAgentStore } from '../agent'

// Mock Tauri invoke
vi.mock('@tauri-apps/api/core', () => ({
  invoke: vi.fn().mockResolvedValue(undefined)
}))

describe('ConversationStore', () => {
  beforeEach(() => setActivePinia(createPinia()))

  it('appends message', () => {
    const store = useConversationStore()
    store.appendMessage({ id: '1', role: 'user', content: 'Hello', timestamp: Date.now() })
    expect(store.messages).toHaveLength(1)
    expect(store.messages[0].content).toBe('Hello')
  })

  it('sets plan', () => {
    const store = useConversationStore()
    store.setPlan({ steps: [{ id: 's1', label: 'Step 1', state: 'pending', index: 0 }], approved: null })
    expect(store.currentPlan?.steps).toHaveLength(1)
  })

  it('updates step state', () => {
    const store = useConversationStore()
    store.setPlan({ steps: [{ id: 's1', label: 'Step 1', state: 'pending', index: 0 }], approved: null })
    store.updateStep('s1', 'active')
    expect(store.currentPlan?.steps[0].state).toBe('active')
  })
})

describe('AgentStore', () => {
  beforeEach(() => setActivePinia(createPinia()))

  it('updates credits', () => {
    const store = useAgentStore()
    store.updateCredits({ current: 42, max: 100 })
    expect(store.credits.current).toBe(42)
  })
})
```

**Step 2: Run to see fail**

```bash
npm test -- stores
```

**Step 3: Implement stores fully**

`conversation.ts`:
```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { Message, Plan, Step } from '@/shared/types'

export const useConversationStore = defineStore('conversation', () => {
  const messages = ref<Message[]>([])
  const currentPlan = ref<Plan | null>(null)
  const scrollPinned = ref(true)

  function appendMessage(msg: Message): void {
    messages.value.push(msg)
  }

  function setPlan(plan: Plan): void {
    currentPlan.value = plan
  }

  function updateStep(stepId: string, state: Step['state']): void {
    if (!currentPlan.value) return
    const step = currentPlan.value.steps.find(s => s.id === stepId)
    if (step) step.state = state
  }

  return { messages, currentPlan, scrollPinned, appendMessage, setPlan, updateStep }
})
```

`agent.ts`:
```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { CreditInfo } from '@/shared/types'

export const useAgentStore = defineStore('agent', () => {
  const credits = ref<CreditInfo>({ current: 0, max: 100 })
  const activeAgents = ref<string[]>([])
  const connectionStatus = ref<'connected' | 'disconnected' | 'connecting'>('disconnected')

  function updateCredits(info: CreditInfo): void {
    credits.value = info
  }

  return { credits, activeAgents, connectionStatus, updateCredits }
})
```

`app.ts` (with config persistence):
```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { invoke } from '@tauri-apps/api/core'
import type { UIMode } from '@/shared/types'

export const useAppStore = defineStore('app', () => {
  const uiMode = ref<UIMode>('full')

  async function switchMode(mode: UIMode): Promise<void> {
    await invoke('set_config', { key: 'ui_mode', value: mode })
    uiMode.value = mode
    if (mode === 'full') {
      await invoke('resize_window', { width: 1200, height: 760 })
    } else if (mode === 'copilot') {
      await invoke('resize_window', { width: 420, height: 720 })
    }
    // ninja handled by NinjaApp visibility
  }

  async function init(): Promise<void> {
    try {
      const savedMode = await invoke<string>('get_config', { key: 'ui_mode' })
      if (savedMode && ['full', 'copilot', 'ninja'].includes(savedMode)) {
        uiMode.value = savedMode as UIMode
      }
    } catch {
      // Default to full mode
    }
  }

  return { uiMode, switchMode, init }
})
```

**Step 4: Run tests, commit**

```bash
npm test -- stores
git add src/shared/stores/
git commit -m "feat(desktop/stores): implement Pinia stores with full state + actions"
```

---

### Task 19: Implement useConfig and useAgentEvents composables

**Files:** `src/shared/composables/useConfig.ts`, `useAgentEvents.ts`

**useConfig implementation** (Phase 5 wires this up completely; here we implement the invoke wrappers):

```typescript
import { invoke } from '@tauri-apps/api/core'
import type { Config } from '@/shared/types'

export function useConfig() {
  async function getConfig<K extends keyof Config>(key: K): Promise<Config[K] | null> {
    try {
      const value = await invoke<string>('get_config', { key: String(key) })
      return value ? (value as unknown as Config[K]) : null
    } catch {
      return null
    }
  }

  async function setConfig<K extends keyof Config>(key: K, value: Config[K]): Promise<void> {
    await invoke('set_config', { key: String(key), value: String(value) })
  }

  return { getConfig, setConfig }
}
```

**useAgentEvents** (Phase 5 implements event dispatch; here we implement the Tauri event listener infrastructure):

```typescript
import { listen, type UnlistenFn } from '@tauri-apps/api/event'
import type { AgentEvent } from '@/shared/types'

export function useAgentEvents() {
  let unlisten: UnlistenFn | null = null

  async function startListening(handler: (event: AgentEvent) => void): Promise<void> {
    unlisten = await listen<AgentEvent>('agent_event', (event) => {
      handler(event.payload)
    })
  }

  function stopListening(): void {
    if (unlisten) {
      unlisten()
      unlisten = null
    }
  }

  return { startListening, stopListening }
}
```

**Commit:**

```bash
git add src/shared/composables/
git commit -m "feat(desktop/composables): implement useConfig (invoke wrappers), useAgentEvents (Tauri listener)"
```

**Phase 2-B exit gate:** `invoke('set_config', { key: 'ui_mode', value: 'full' })` writes to `~/.d1doctor/config.toml`. Store unit tests pass.

---

## Phase 3-A — Full Mode Implementation

> **Ownership:** `src/modes/full/**` only. Import shared components + stores. Do NOT modify them.

### Task 20: Implement TitleBar.vue

**File:** `crates/desktop/src/modes/full/TitleBar.vue`

**Spec §2.3:** 38px height, backdrop blur, drag region, traffic lights with correct colors

**Test:**
```typescript
it('renders traffic light dots', () => {
  const wrapper = mount(TitleBar)
  const dots = wrapper.findAll('.traffic-dot')
  expect(dots).toHaveLength(3)
})
it('title bar has drag region style', () => {
  const wrapper = mount(TitleBar)
  const bar = wrapper.find('.title-bar')
  expect(bar.attributes('style') || bar.html()).toBeTruthy()
})
```

**Implementation:**
```vue
<template>
  <div class="title-bar">
    <div class="traffic-lights">
      <div class="traffic-dot close" title="Close" @click="closeWindow" />
      <div class="traffic-dot minimize" title="Minimize" @click="minimizeWindow" />
      <div class="traffic-dot maximize" title="Maximize" @click="maximizeWindow" />
    </div>
    <span class="window-title">Day 1 Doctor — Workspace</span>
    <div class="title-actions">
      <!-- mode switch, search icons -->
    </div>
  </div>
</template>

<script setup lang="ts">
import { getCurrentWindow } from '@tauri-apps/api/window'

async function closeWindow() { await getCurrentWindow().close() }
async function minimizeWindow() { await getCurrentWindow().minimize() }
async function maximizeWindow() { await getCurrentWindow().toggleMaximize() }
</script>

<style scoped>
.title-bar {
  height: 38px;
  background: var(--surface-title-bar);
  backdrop-filter: blur(30px) saturate(150%);
  -webkit-backdrop-filter: blur(30px) saturate(150%);
  border-bottom: 1px solid var(--border);
  -webkit-app-region: drag;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  flex-shrink: 0;
}

.traffic-lights {
  -webkit-app-region: no-drag;
  display: flex;
  gap: 8px;
}

.traffic-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  cursor: pointer;
  transition: opacity 0.15s;
}
.traffic-dot:hover { opacity: 0.8; }
.close { background: var(--traffic-close); }
.minimize { background: var(--traffic-minimize); }
.maximize { background: var(--traffic-maximize); }

.window-title {
  flex: 1;
  text-align: center;
  font: 12px var(--font-mono);
  color: var(--text-muted);
  pointer-events: none;
}

.title-actions {
  -webkit-app-region: no-drag;
  display: flex;
  gap: 8px;
}
</style>
```

**Commit:**
```bash
git commit -m "feat(desktop/full): implement TitleBar (traffic lights, drag region, backdrop blur)"
```

---

### Task 21: Implement Sidebar.vue

**Spec §2.4:** 260px, backdrop blur, 5 sections: logo, nav (active state), recent tasks, CreditBar (full), user section

```vue
<template>
  <aside class="sidebar">
    <!-- Logo -->
    <div class="sidebar-logo">
      <div class="logo-mark">D1</div>
      <div class="logo-text">
        <div class="logo-name">Day 1 Doctor</div>
        <div class="logo-version">v2.4.0</div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav">
      <button v-for="item in navItems" :key="item.id"
        class="nav-item" :class="{ active: activeNav === item.id }"
        @click="activeNav = item.id">
        <span class="nav-icon">{{ item.icon }}</span>
        <span class="nav-label">{{ item.label }}</span>
      </button>
    </nav>

    <!-- Recent Tasks -->
    <div class="sidebar-section">
      <div class="section-label">Recent Tasks</div>
      <div class="task-item" v-for="task in recentTasks" :key="task.id">
        <span class="task-dot" :class="task.status" />
        <span class="task-name">{{ task.name }}</span>
        <span class="task-time">{{ task.time }}</span>
      </div>
    </div>

    <div class="sidebar-spacer" />

    <!-- Credits -->
    <div class="sidebar-credits">
      <CreditBar :credits="agentStore.credits.current" :max="agentStore.credits.max" variant="full" />
    </div>

    <!-- User -->
    <div class="sidebar-user">
      <div class="user-avatar">U</div>
      <div class="user-info">
        <div class="user-name">Developer</div>
        <div class="user-email">dev@example.com</div>
      </div>
    </div>
  </aside>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useAgentStore } from '@/shared/stores/agent'
import CreditBar from '@/shared/components/CreditBar.vue'

const agentStore = useAgentStore()
const activeNav = ref('chat')

const navItems = [
  { id: 'chat', icon: '💬', label: 'Chat' },
  { id: 'tasks', icon: '✓', label: 'Tasks' },
  { id: 'knowledge', icon: '📚', label: 'Knowledge' },
  { id: 'settings', icon: '⚙', label: 'Settings' },
]

const recentTasks = ref([
  { id: '1', name: 'Install Node.js', status: 'done', time: '2m ago' },
  { id: '2', name: 'Configure Git', status: 'active', time: 'now' },
])
</script>

<style scoped>
.sidebar {
  width: 260px;
  background: var(--surface-sidebar);
  backdrop-filter: blur(30px) saturate(140%);
  -webkit-backdrop-filter: blur(30px) saturate(140%);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 16px 0;
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar-logo { display: flex; align-items: center; gap: 10px; padding: 0 16px 16px; border-bottom: 1px solid var(--border); }
.logo-mark { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-hover)); display: flex; align-items: center; justify-content: center; font: 700 14px var(--font-mono); color: white; }
.logo-name { font: 700 13px var(--font-mono); color: var(--text-primary); }
.logo-version { font: 10px var(--font-mono); color: var(--text-disabled); }

.sidebar-nav { padding: 8px 0; }
.nav-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 9px 16px; background: none; border: none; border-left: 2px solid transparent; color: var(--text-secondary); font: 13px var(--font-mono); cursor: pointer; transition: all 0.15s; }
.nav-item:hover { background: var(--accent-soft); color: var(--text-primary); }
.nav-item.active { background: var(--accent-soft); border-left-color: var(--accent); color: var(--accent); }

.sidebar-section { padding: 12px 16px; }
.section-label { font: 10px var(--font-mono); color: var(--text-disabled); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px; }
.task-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; }
.task-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.task-dot.done { background: var(--success); }
.task-dot.active { background: var(--accent); }
.task-name { flex: 1; font: 12px var(--font-mono); color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.task-time { font: 10px var(--font-mono); color: var(--text-disabled); }

.sidebar-spacer { flex: 1; }
.sidebar-credits { padding: 12px 16px; border-top: 1px solid var(--border); }
.sidebar-user { display: flex; align-items: center; gap: 10px; padding: 12px 16px; }
.user-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--muted); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font: 700 11px var(--font-mono); color: var(--text-secondary); }
.user-name { font: 700 12px var(--font-mono); color: var(--text-primary); }
.user-email { font: 10px var(--font-mono); color: var(--text-disabled); }
</style>
```

**Commit:**
```bash
git commit -m "feat(desktop/full): implement Sidebar (260px, 5 sections, nav active state, credit bar)"
```

---

### Task 22: Implement ChatWorkspace.vue

**Spec §2.5:** Message list with auto-scroll, "↓ New messages" badge, input bar (Enter/Shift+Enter/↑)

Key behaviors:
- Auto-scroll only if user was at bottom (within 100px threshold)
- Show "↓ New messages" badge when scrolled up and new message arrives
- Enter = submit, Shift+Enter = newline, ↑ = recall last message

```vue
<template>
  <div class="chat-workspace">
    <div class="message-list" ref="messageListRef" @scroll="onScroll">
      <MessageBubble
        v-for="msg in conversationStore.messages"
        :key="msg.id"
        v-bind="msg"
      />
      <PlanCard
        v-if="conversationStore.currentPlan"
        :steps="conversationStore.currentPlan.steps"
        :on-approve="approvePlan"
        :on-reject="rejectPlan"
      />
    </div>

    <Transition name="badge-slide">
      <button v-if="showNewMessageBadge" class="new-message-badge" @click="scrollToBottom">
        ↓ New messages
      </button>
    </Transition>

    <div class="input-bar">
      <div class="input-pill" :class="{ focused: inputFocused }">
        <textarea
          ref="textareaRef"
          v-model="inputValue"
          placeholder="Ask Day 1 Doctor anything..."
          rows="1"
          @focus="inputFocused = true"
          @blur="inputFocused = false"
          @keydown="onKeydown"
          @input="autoResize"
        />
        <button class="send-btn" :disabled="!inputValue.trim()" @click="submit">→</button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, nextTick } from 'vue'
import { useConversationStore } from '@/shared/stores/conversation'
import MessageBubble from '@/shared/components/MessageBubble.vue'
import PlanCard from '@/shared/components/PlanCard.vue'
import type { Message } from '@/shared/types'

const conversationStore = useConversationStore()
const messageListRef = ref<HTMLElement | null>(null)
const textareaRef = ref<HTMLTextAreaElement | null>(null)
const inputValue = ref('')
const inputFocused = ref(false)
const showNewMessageBadge = ref(false)
const messageHistory: string[] = []
let historyIndex = -1

function isNearBottom(): boolean {
  if (!messageListRef.value) return true
  const { scrollTop, scrollHeight, clientHeight } = messageListRef.value
  return scrollHeight - scrollTop - clientHeight < 100
}

function scrollToBottom(): void {
  if (!messageListRef.value) return
  messageListRef.value.scrollTop = messageListRef.value.scrollHeight
  showNewMessageBadge.value = false
  conversationStore.scrollPinned = true
}

function onScroll(): void {
  conversationStore.scrollPinned = isNearBottom()
  if (isNearBottom()) showNewMessageBadge.value = false
}

watch(
  () => conversationStore.messages.length,
  async () => {
    if (conversationStore.scrollPinned) {
      await nextTick()
      scrollToBottom()
    } else {
      showNewMessageBadge.value = true
    }
  }
)

function autoResize(): void {
  if (!textareaRef.value) return
  textareaRef.value.style.height = 'auto'
  textareaRef.value.style.height = Math.min(textareaRef.value.scrollHeight, 160) + 'px'
}

function onKeydown(e: KeyboardEvent): void {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault()
    submit()
  } else if (e.key === 'ArrowUp' && !inputValue.value) {
    if (messageHistory.length > 0) {
      historyIndex = Math.min(historyIndex + 1, messageHistory.length - 1)
      inputValue.value = messageHistory[historyIndex]
    }
  }
}

function submit(): void {
  if (!inputValue.value.trim()) return
  const msg: Message = {
    id: crypto.randomUUID(),
    role: 'user',
    content: inputValue.value.trim(),
    timestamp: Date.now(),
  }
  messageHistory.unshift(msg.content)
  historyIndex = -1
  conversationStore.appendMessage(msg)
  inputValue.value = ''
  if (textareaRef.value) textareaRef.value.style.height = 'auto'
}

function approvePlan(): void {
  if (conversationStore.currentPlan) {
    conversationStore.currentPlan.approved = true
  }
}

function rejectPlan(): void {
  if (conversationStore.currentPlan) {
    conversationStore.currentPlan.approved = false
  }
}
</script>

<style scoped>
.chat-workspace {
  flex: 1;
  background: var(--surface-chat);
  backdrop-filter: blur(24px) saturate(130%);
  -webkit-backdrop-filter: blur(24px) saturate(130%);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  min-width: 400px;
}

.message-list {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

.message-list::-webkit-scrollbar { width: 4px; }
.message-list::-webkit-scrollbar-track { background: transparent; }
.message-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.new-message-badge {
  position: absolute;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 16px;
  font: 11px var(--font-mono);
  cursor: pointer;
  z-index: 10;
  box-shadow: 0 4px 12px var(--accent-glow);
}

.badge-slide-enter-active, .badge-slide-leave-active { transition: all 0.2s ease; }
.badge-slide-enter-from, .badge-slide-leave-to { opacity: 0; transform: translateX(-50%) translateY(8px); }

.input-bar {
  padding: 16px 24px;
  background: rgba(13, 13, 13, 0.6);
  border-top: 1px solid var(--border);
}

.input-pill {
  background: var(--muted);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 16px;
  display: flex;
  align-items: flex-end;
  gap: 12px;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.input-pill.focused {
  border-color: var(--accent-border);
  box-shadow: 0 0 0 3px var(--accent-soft);
}

textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-primary);
  font: 13px/1.6 var(--font-mono);
  resize: none;
  outline: none;
  max-height: 160px;
  overflow-y: auto;
  min-height: 20px;
}

textarea::placeholder { color: var(--text-disabled); }

.send-btn {
  background: var(--accent);
  border: none;
  border-radius: 6px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.15s;
}
.send-btn:disabled { background: var(--muted); color: var(--text-disabled); cursor: not-allowed; }
.send-btn:not(:disabled):hover { background: var(--accent-hover); }
</style>
```

**Commit:**
```bash
git commit -m "feat(desktop/full): implement ChatWorkspace (auto-scroll, new-msg badge, Enter/↑ shortcuts)"
```

---

### Task 23: Implement UtilityPanel.vue and FullMode.vue

**UtilityPanel spec §2.6:** 280px, 5 collapsible sections: Task Info, Agents, Permissions, System Health (auto-refresh 5s), Connection

```vue
<!-- UtilityPanel.vue -->
<template>
  <aside class="utility-panel">
    <CollapsibleSection v-for="section in sections" :key="section.id" :title="section.title" :default-open="true">
      <component :is="section.component" />
    </CollapsibleSection>
  </aside>
</template>
```

Each section component shows stub data. System Health section uses `setInterval` every 5000ms to refresh `Date.now()` (actual system data would come from Tauri commands added in future).

**FullMode.vue** wires all three panes together:

```vue
<template>
  <div class="full-mode">
    <TitleBar />
    <div class="main-content">
      <Sidebar />
      <ChatWorkspace />
      <UtilityPanel />
    </div>
  </div>
</template>
```

**Commit:**
```bash
git commit -m "feat(desktop/full): implement UtilityPanel (5 collapsible sections, 5s health refresh) + FullMode root"
```

---

## Phase 3-B — Copilot Mode Implementation

> **Ownership:** `src/modes/copilot/**` only.

### Task 24: Implement CopilotMode.vue, CopilotHeader.vue, SessionBar.vue, CopilotInput.vue

**Spec §3:** 420px panel, positioned 12px from right/top, draggable

`CopilotMode.vue`:
```vue
<template>
  <div class="copilot copilot-panel">
    <CopilotHeader />
    <SessionBar />
    <div class="copilot-messages" ref="msgListRef" @scroll="onScroll">
      <MessageBubble v-for="msg in store.messages" :key="msg.id" v-bind="msg" />
    </div>
    <CopilotInput />
    <CreditBar :credits="agentStore.credits.current" :max="agentStore.credits.max" variant="mini" />
  </div>
</template>
```

CSS per spec §3.3:
```css
.copilot-panel {
  width: 420px;
  height: 100vh;
  background: var(--surface-copilot);
  backdrop-filter: blur(40px) saturate(160%);
  -webkit-backdrop-filter: blur(40px) saturate(160%);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
}
/* Condensed overrides per spec §3.4 */
.copilot :deep(.message-bubble) { font-size: 12px; padding: 10px 14px; }
.copilot :deep(.agent-avatar) { width: 26px; height: 26px; font-size: 9px; }
```

SessionBar per spec §3.5 — height 42px, session name, green status dot, credit estimate.

CopilotInput — same as Full mode input but with `.copilot .input-pill { padding: 8px 12px }` and `max-height: 2 lines`.

**Commit:**
```bash
git commit -m "feat(desktop/copilot): implement Copilot Mode (420px panel, condensed messages, session bar)"
```

---

## Phase 3-C — Ninja Mode Implementation

> **Ownership:** `src/modes/ninja/**` and `Cmd+Shift+D` in `src-tauri/src/main.rs`

### Task 25: Implement NinjaBar.vue

**Spec §4.2:** 680px pill bar, logo, input, send icon

```vue
<template>
  <div class="ninja-bar">
    <div class="ninja-logo">D1</div>
    <input
      ref="inputRef"
      v-model="query"
      class="ninja-input"
      placeholder="Ask Day 1 Doctor..."
      @keydown.enter="submit"
      @keydown.esc="handleEsc"
      @input="onInput"
      autofocus
    />
    <button class="ninja-send" @click="submit">→</button>
  </div>
  <div class="ninja-shortcuts" :class="{ hidden: shortcutsHidden }">
    <KbdShortcut :keys="['⌘', '⇧', 'D']" /> Toggle
    <KbdShortcut :keys="['Esc']" /> Dismiss
    <KbdShortcut :keys="['↵']" /> Send
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import KbdShortcut from '@/shared/components/KbdShortcut.vue'

const emit = defineEmits<{ submit: [query: string]; esc: [] }>()
const query = ref('')
const shortcutsHidden = ref(false)
let fadeTimer: ReturnType<typeof setTimeout> | null = null

function onInput() {
  if (fadeTimer) clearTimeout(fadeTimer)
  shortcutsHidden.value = true
  fadeTimer = setTimeout(() => { shortcutsHidden.value = false }, 3000)
}

function submit() {
  if (!query.value.trim()) return
  emit('submit', query.value.trim())
}

function handleEsc() { emit('esc') }
</script>

<style scoped>
.ninja-bar {
  width: 680px;
  height: 64px;
  background: var(--surface-ninja-bar);
  backdrop-filter: blur(50px) saturate(180%);
  -webkit-backdrop-filter: blur(50px) saturate(180%);
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 24px 64px rgba(0,0,0,0.7), 0 0 0 1px rgba(249,115,22,0.1);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 14px;
}

.ninja-logo {
  width: 40px; height: 40px; border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  box-shadow: 0 0 20px var(--accent-glow);
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  color: white; font: 700 18px var(--font-mono);
}

.ninja-input {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--text-primary); font: 16px/1 var(--font-mono); caret-color: var(--accent);
}
.ninja-input::placeholder { color: var(--text-disabled); }

.ninja-send {
  background: var(--accent); border: none; border-radius: 8px;
  width: 32px; height: 32px; color: white; font-size: 16px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
}
.ninja-send:hover { background: var(--accent-hover); }

.ninja-shortcuts {
  display: flex; gap: 20px; align-items: center;
  font: 11px var(--font-mono); color: var(--text-muted);
  opacity: 0.6; transition: opacity 0.5s;
  position: absolute; top: calc(18% + 72px); left: 50%; transform: translateX(-50%);
  pointer-events: none;
}
.ninja-shortcuts.hidden { opacity: 0; }
</style>
```

**Commit:**
```bash
git commit -m "feat(desktop/ninja): implement NinjaBar (680px pill, logo, input, shortcut hints)"
```

---

### Task 26: Implement NinjaDropdown.vue and StepTimeline.vue

**Spec §4.3, §4.4:** slideDown animation, step timeline with connector lines, footer with progress bar

`StepTimeline.vue` — renders steps with vertical connector lines that change color based on state (per spec §4.4 CSS).

`NinjaDropdown.vue`:
```vue
<template>
  <div class="ninja-dropdown">
    <div class="query-echo">{{ '> ' + query }}</div>
    <div class="agent-label">● Day 1 Doctor  [Planner Agent]</div>
    <StepTimeline :steps="steps" />
    <ResultCard v-if="result" v-bind="result" />
    <div class="dropdown-footer">
      <div class="progress-track"><div class="progress-fill" :style="{ width: progress + '%' }" /></div>
      <span class="credit-cost">~{{ creditCost }} credits</span>
      <button class="btn-approve" @click="$emit('approve')">✓ Approve</button>
      <button class="btn-dismiss" @click="$emit('dismiss')">✕</button>
    </div>
  </div>
</template>
```

CSS per spec §4.3: `animation: slideDown 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards`

**Commit:**
```bash
git commit -m "feat(desktop/ninja): implement NinjaDropdown (slideDown, step timeline, footer) + StepTimeline"
```

---

### Task 27: Implement NinjaApp.vue and Cmd+Shift+D global shortcut

**NinjaApp.vue** — manages bar/dropdown show state, Esc handling (first press: hide dropdown, second: hide window):

```vue
<template>
  <NinjaBar @submit="onSubmit" @esc="onEsc" />
  <NinjaDropdown v-if="showDropdown" :query="lastQuery" :steps="steps" @dismiss="onDismiss" />
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { getCurrentWindow } from '@tauri-apps/api/window'
import NinjaBar from './NinjaBar.vue'
import NinjaDropdown from './NinjaDropdown.vue'
import type { Step } from '@/shared/types'

const showDropdown = ref(false)
const lastQuery = ref('')
const steps = ref<Step[]>([])

function onSubmit(query: string) {
  lastQuery.value = query
  showDropdown.value = true
}

function onEsc() {
  if (showDropdown.value) {
    showDropdown.value = false
  } else {
    getCurrentWindow().hide()
  }
}

function onDismiss() {
  showDropdown.value = false
}
</script>
```

**Cmd+Shift+D in lib.rs** — implement global shortcut toggle per spec §4.6:

```rust
// In lib.rs, after plugin registration, inside setup callback:
app.global_shortcut().on_shortcut(
    Shortcut::new(Some(Modifiers::SUPER | Modifiers::SHIFT), Code::KeyD),
    |app, _shortcut, _event| {
        if let Some(window) = app.get_webview_window("ninja-bar") {
            if window.is_visible().unwrap_or(false) {
                let _ = window.hide();
            } else {
                let _ = window.show();
                let _ = window.set_focus();
            }
        }
    },
)?;
```

**Commit:**
```bash
git commit -m "feat(desktop/ninja): implement NinjaApp Esc handling + Cmd+Shift+D global shortcut"
```

---

## Phase 4 — Mode Switching Integration

### Task 28: Wire mode switching in App.vue and app store

**Spec §5.2:** switchMode writes config, resizes window, shows/hides ninja bar

Update `src/App.vue` to init the app store on mount and read saved mode from config:

```vue
<template>
  <FullMode v-if="appStore.uiMode === 'full'" />
  <CopilotMode v-else-if="appStore.uiMode === 'copilot'" />
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import { useAppStore } from '@/shared/stores/app'
import FullMode from '@/modes/full/FullMode.vue'
import CopilotMode from '@/modes/copilot/CopilotMode.vue'

const appStore = useAppStore()
onMounted(() => appStore.init())
</script>
```

**Test mode switching:**

```typescript
it('switchMode full → copilot writes config and updates uiMode', async () => {
  const mockInvoke = vi.fn().mockResolvedValue(undefined)
  vi.mock('@tauri-apps/api/core', () => ({ invoke: mockInvoke }))

  const store = useAppStore()
  await store.switchMode('copilot')

  expect(mockInvoke).toHaveBeenCalledWith('set_config', { key: 'ui_mode', value: 'copilot' })
  expect(store.uiMode).toBe('copilot')
})

it('init reads saved mode from config', async () => {
  const mockInvoke = vi.fn().mockResolvedValue('copilot')
  vi.mock('@tauri-apps/api/core', () => ({ invoke: mockInvoke }))

  const store = useAppStore()
  await store.init()
  expect(store.uiMode).toBe('copilot')
})
```

**Commit:**
```bash
git commit -m "feat(desktop): wire mode switching — config persistence + window resize on switch"
```

---

## Phase 5 — Agent Event Wiring

### Task 29: Implement useAgentEvents full dispatch

**Spec §6.2:** Wire all 8 event types to store mutations

```typescript
// src/shared/composables/useAgentEvents.ts
import { listen, type UnlistenFn } from '@tauri-apps/api/event'
import { useConversationStore } from '@/shared/stores/conversation'
import { useAgentStore } from '@/shared/stores/agent'
import type { AgentEvent, Message } from '@/shared/types'

export function useAgentEvents() {
  let unlisten: UnlistenFn | null = null

  async function startListening(): Promise<void> {
    const conversationStore = useConversationStore()
    const agentStore = useAgentStore()

    unlisten = await listen<AgentEvent>('agent_event', ({ payload: event }) => {
      switch (event.type) {
        case 'plan_proposed': {
          const plan = event.payload as { steps: import('@/shared/types').Step[] }
          conversationStore.setPlan({ steps: plan.steps, approved: null })
          break
        }
        case 'step_started': {
          const { stepId } = event.payload as { stepId: string }
          conversationStore.updateStep(stepId, 'active')
          break
        }
        case 'step_completed': {
          const { stepId } = event.payload as { stepId: string }
          conversationStore.updateStep(stepId, 'done')
          break
        }
        case 'step_failed': {
          const { stepId } = event.payload as { stepId: string }
          conversationStore.updateStep(stepId, 'error')
          break
        }
        case 'agent_message': {
          const { content } = event.payload as { content: string }
          const msg: Message = {
            id: crypto.randomUUID(),
            role: 'agent',
            content,
            timestamp: Date.now(),
          }
          conversationStore.appendMessage(msg)
          break
        }
        case 'result_ready': {
          const { title, detail, code } = event.payload as { title: string; detail: string; code?: string }
          conversationStore.appendMessage({
            id: crypto.randomUUID(),
            role: 'agent',
            content: `__result__:${JSON.stringify({ title, detail, code })}`,
            timestamp: Date.now(),
          })
          break
        }
        case 'credits_updated': {
          const { current, max } = event.payload as { current: number; max: number }
          agentStore.updateCredits({ current, max })
          break
        }
        case 'permission_requested': {
          const { label } = event.payload as { label: string }
          conversationStore.appendMessage({
            id: crypto.randomUUID(),
            role: 'agent',
            content: `__permission__:${label}`,
            timestamp: Date.now(),
          })
          break
        }
      }
    })
  }

  function stopListening(): void {
    if (unlisten) { unlisten(); unlisten = null }
  }

  return { startListening, stopListening }
}
```

**Integration test:**

```typescript
// __tests__/useAgentEvents.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useConversationStore } from '@/shared/stores/conversation'
import { useAgentStore } from '@/shared/stores/agent'

describe('useAgentEvents', () => {
  let handler: (event: { payload: import('@/shared/types').AgentEvent }) => void

  beforeEach(() => {
    setActivePinia(createPinia())
    vi.mock('@tauri-apps/api/event', () => ({
      listen: vi.fn().mockImplementation((_event, cb) => {
        handler = cb
        return Promise.resolve(() => {})
      })
    }))
  })

  it('plan_proposed → setPlan on conversationStore', async () => {
    const { useAgentEvents } = await import('@/shared/composables/useAgentEvents')
    const { startListening } = useAgentEvents()
    await startListening()
    const store = useConversationStore()

    handler({ payload: {
      type: 'plan_proposed',
      payload: { steps: [{ id: 's1', label: 'Step 1', state: 'pending', index: 0 }] }
    }})
    expect(store.currentPlan?.steps).toHaveLength(1)
  })

  it('credits_updated → updateCredits on agentStore', async () => {
    const { useAgentEvents } = await import('@/shared/composables/useAgentEvents')
    const { startListening } = useAgentEvents()
    await startListening()
    const store = useAgentStore()

    handler({ payload: { type: 'credits_updated', payload: { current: 50, max: 100 } }})
    expect(store.credits.current).toBe(50)
  })
})
```

**Commit:**
```bash
git commit -m "feat(desktop): implement agent event wiring — all 8 event types → store mutations"
```

---

### Task 30: Final build verification + update ship file

**Step 1: Run full test suite**

```bash
cd /Users/wenqingyu/Documents/workspace/day1-doctor/d1-doctor-app/crates/desktop
npm test
```

Expected: All tests pass.

**Step 2: Run TypeScript build**

```bash
npm run build
```

Expected: Zero errors, two bundles in `dist/`.

**Step 3: Run Rust check**

```bash
cd src-tauri
cargo check
```

Expected: Zero errors.

**Step 4: Update v2.4.0.md ship file — change status to Dev In Progress**

Edit `/Users/wenqingyu/Documents/workspace/day1-doctor/day1-doctor-prd/progress/v2.4.0.md`:
- Line 3: Change `✅ PRD Locked` → `🔨 Dev In Progress`
- Timeline table: Add kickoff date for "Dev Kickoff" row → `2026-02-26` with status `✅ Done`
- Dev Team Checklist — Kickoff section: check all items

**Step 5: Final commit**

```bash
git add -A
git commit -m "feat(desktop): v2.4.0 Phase 5 complete — all 43 acceptance criteria implementation done"
```

---

## Acceptance Criteria Checklist

All 43 criteria from spec §8 must pass before `🧪 Dev Testing`:

### Full Mode (13)
- [ ] Three-pane layout renders at 1200×760, resizable, min 900×600
- [ ] Custom title bar with traffic light dots (correct colors)
- [ ] Dragging title bar moves the window
- [ ] Sidebar 260px, scrollable, all sections visible
- [ ] Chat auto-scrolls on new message, shows "↓ New messages" when scrolled up
- [ ] Input submits on Enter, newline on Shift+Enter
- [ ] ↑ recalls last message
- [ ] Utility panel 280px, all sections collapsible
- [ ] System health refreshes every 5s
- [ ] Credit bar shows balance
- [ ] All design tokens applied (no hardcoded hex)
- [ ] Backdrop blur visible over desktop wallpaper
- [ ] Backdrop-filter fallback for unavailable translucency

### Copilot Mode (7)
- [ ] Panel 420px, positioned 12px from right edge
- [ ] Draggable, position persists across switches
- [ ] Session bar: name and status dot
- [ ] Messages use 12px font, 26px avatars
- [ ] Mini credit bar at bottom, updates in real time
- [ ] Plan cards render within 420px
- [ ] Input compact (8px padding)

### Ninja Mode (12)
- [ ] Cmd+Shift+D shows/hides bar from any app
- [ ] Bar 680px, pill-shaped (20px radius), centered at 18% from top
- [ ] Bar always-on-top, not in taskbar
- [ ] Enter shows dropdown below bar
- [ ] Dropdown slides in (0.25s cubic-bezier)
- [ ] Step timeline with correct state indicators
- [ ] Connector lines update color on step complete
- [ ] Progress bar tracks completion
- [ ] Approve/dismiss buttons work
- [ ] First Esc dismisses dropdown, second hides bar
- [ ] Shortcut hints fade after 3s typing, reappear on hover
- [ ] Agent pulse animation on active step

### Mode Switching (5)
- [ ] Switch accessible from all modes
- [ ] ui_mode written to ~/.d1doctor/config.toml
- [ ] Window resizes/repositions on switch
- [ ] Conversation state preserved
- [ ] Mode persists across restarts

### Design System (6)
- [ ] All colors use CSS variables
- [ ] WCAG AA contrast (orange on #050505)
- [ ] prefers-reduced-motion disables animations
- [ ] -webkit-backdrop-filter alongside backdrop-filter everywhere
- [ ] Font stack falls back correctly
- [ ] All transitions ≤ 300ms
