# Design: v2.4.0 Mac Client â€” Three Mode UI/UX

> Date: 2026-02-26 | Author: Engineering | Status: Approved
> PRD Spec: `day1-doctor-prd/03-design/MacClient_UIUX_Iteration.md`
> Ship File: `day1-doctor-prd/progress/v2.4.0.md`

---

## Problem

The Day 1 Doctor desktop app has no client implementation. The `d1-doctor-app/crates/desktop/` crate has a Tauri v1 config stub and empty source directories. This design covers the full implementation of the three interaction modes â€” Full, Copilot, Ninja â€” per the locked v2.4.0 PRD spec.

---

## Decision: Approach B â€” Two Vite Entry Points

Two separate Vite HTML/TS entries: one for the main window (Full + Copilot modes) and one for the Ninja bar window. Shared components and stores live in `src/shared/` and are imported by both entries. Tauri inter-window IPC (`emit_to()`) synchronises state across windows.

**Why not Approach A (single entry):** Single-entry requires runtime URL param differentiation between windows, couples Ninja bar state to the main window bundle, and makes the two-window Tauri architecture harder to reason about.

**Why not Approach C (workspace packages per mode):** Overkill overhead for a small team at this stage.

---

## Directory Structure

```
crates/desktop/
â”œâ”€â”€ src/                                â† Vue + TypeScript (Vite root)
â”‚   â”œâ”€â”€ index.html                      â† main window entry HTML
â”‚   â”œâ”€â”€ ninja.html                      â† ninja-bar window entry HTML
â”‚   â”œâ”€â”€ main.ts                         â† mounts App.vue on #app
â”‚   â”œâ”€â”€ ninja.ts                        â† mounts NinjaApp.vue on #ninja-app
â”‚   â”œâ”€â”€ App.vue                         â† root: <FullMode> or <CopilotMode> via uiMode store
â”‚   â”œâ”€â”€ NinjaApp.vue                    â† root: <NinjaBar> + <NinjaDropdown>
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ types.ts                    â† All shared TS types (UIMode, AgentEvent, Message, Stepâ€¦)
â”‚   â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”‚   â”œâ”€â”€ tokens.css             â† :root CSS custom properties (spec Â§1.1)
â”‚   â”‚   â”‚   â””â”€â”€ animations.css         â† agentPulse, slideDown, fadeIn + reduced-motion
â”‚   â”‚   â”œâ”€â”€ components/                â† 8 shared components (spec Â§1.4)
â”‚   â”‚   â”‚   â”œâ”€â”€ AgentAvatar.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageBubble.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ StepIndicator.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ PlanCard.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ ResultCard.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ CreditBar.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ PermissionBadge.vue
â”‚   â”‚   â”‚   â””â”€â”€ KbdShortcut.vue
â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”œâ”€â”€ app.ts                 â† uiMode: UIMode, switchMode(), reads config on init
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation.ts        â† messages[], currentPlan, steps[], scrollPinned
â”‚   â”‚   â”‚   â””â”€â”€ agent.ts               â† credits, activeAgents[], connectionStatus
â”‚   â”‚   â””â”€â”€ composables/
â”‚   â”‚       â”œâ”€â”€ useAgentEvents.ts      â† Tauri 'agent_event' listener â†’ dispatches to stores
â”‚   â”‚       â””â”€â”€ useConfig.ts           â† invoke('get_config') / invoke('set_config') wrappers
â”‚   â”‚
â”‚   â””â”€â”€ modes/
â”‚       â”œâ”€â”€ full/
â”‚       â”‚   â”œâ”€â”€ FullMode.vue            â† three-pane root (spec Â§2.2)
â”‚       â”‚   â”œâ”€â”€ TitleBar.vue            â† traffic lights + drag region (spec Â§2.3)
â”‚       â”‚   â”œâ”€â”€ Sidebar.vue             â† 260px: logo, nav, tasks, CreditBar, user (spec Â§2.4)
â”‚       â”‚   â”œâ”€â”€ ChatWorkspace.vue       â† message list + auto-scroll + input bar (spec Â§2.5)
â”‚       â”‚   â””â”€â”€ UtilityPanel.vue        â† 280px, 5 collapsible sections (spec Â§2.6)
â”‚       â”œâ”€â”€ copilot/
â”‚       â”‚   â”œâ”€â”€ CopilotMode.vue         â† 420px panel root (spec Â§3.2)
â”‚       â”‚   â”œâ”€â”€ CopilotHeader.vue       â† traffic lights + settings icon (spec Â§3.2)
â”‚       â”‚   â”œâ”€â”€ SessionBar.vue          â† session name + status dot + credit estimate (spec Â§3.5)
â”‚       â”‚   â””â”€â”€ CopilotInput.vue        â† compact input (8px padding) (spec Â§3.6)
â”‚       â””â”€â”€ ninja/
â”‚           â”œâ”€â”€ NinjaBar.vue            â† 680px pill bar, logo, input, send icon (spec Â§4.2)
â”‚           â”œâ”€â”€ NinjaDropdown.vue       â† query echo + step timeline + footer (spec Â§4.3)
â”‚           â””â”€â”€ StepTimeline.vue        â† vertical step connector + dots (spec Â§4.4)
â”‚
â”œâ”€â”€ src-tauri/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs                     â† app setup, two windows, global shortcut Cmd+Shift+D
â”‚   â”‚   â”œâ”€â”€ lib.rs                      â† Tauri builder + command registration
â”‚   â”‚   â””â”€â”€ commands/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â”œâ”€â”€ config.rs               â† get_config(key), set_config(key, value) â†’ config.toml
â”‚   â”‚       â””â”€â”€ window.rs               â† resize_window(w,h), position_window(x,y)
â”‚   â”œâ”€â”€ Cargo.toml                      â† tauri v2, tauri-plugin-global-shortcut/fs/window-state/single-instance
â”‚   â”œâ”€â”€ tauri.conf.json                 â† v2 format: main (1200Ã—760, transparent) + ninja-bar (680Ã—64)
â”‚   â”œâ”€â”€ capabilities/
â”‚   â”‚   â””â”€â”€ default.json               â† Tauri v2 capability grants
â”‚   â””â”€â”€ entitlements.plist              â† com.apple.security.automation.apple-events
â”‚
â”œâ”€â”€ package.json                        â† vue@3, pinia, @tauri-apps/api@2, vite, typescript
â””â”€â”€ vite.config.ts                      â† rollupOptions.input: { main, ninja }
```

---

## Interface Contracts (Phase 1 Deliverable)

Phase 1 writes these contracts. All downstream agents read them â€” never modify them.

### `src/shared/types.ts`

```typescript
export type UIMode = 'full' | 'copilot' | 'ninja'

export interface Message {
  id: string
  role: 'agent' | 'user'
  content: string
  timestamp: number
}

export interface Step {
  id: string
  label: string
  state: 'pending' | 'active' | 'done' | 'error'
  index: number
}

export interface Plan {
  steps: Step[]
  approved: boolean | null
}

export type AgentEventType =
  | 'plan_proposed'
  | 'step_started'
  | 'step_completed'
  | 'step_failed'
  | 'agent_message'
  | 'result_ready'
  | 'credits_updated'
  | 'permission_requested'

export interface AgentEvent {
  type: AgentEventType
  payload: Record<string, unknown>
}

export interface CreditInfo {
  current: number
  max: number
}

export interface Config {
  ui_mode: UIMode
  last_copilot_x: number
  last_copilot_y: number
  theme: 'dark'
}
```

### Store Interfaces (stubs in Phase 1, implemented in Phase 2-B)

```typescript
// stores/app.ts â€” interface
export const useAppStore: () => {
  uiMode: Ref<UIMode>
  switchMode: (mode: UIMode) => Promise<void>
}

// stores/conversation.ts â€” interface
export const useConversationStore: () => {
  messages: Ref<Message[]>
  currentPlan: Ref<Plan | null>
  scrollPinned: Ref<boolean>
  appendMessage: (msg: Message) => void
  setPlan: (plan: Plan) => void
  updateStep: (stepId: string, state: Step['state']) => void
}

// stores/agent.ts â€” interface
export const useAgentStore: () => {
  credits: Ref<CreditInfo>
  activeAgents: Ref<string[]>
  connectionStatus: Ref<'connected' | 'disconnected' | 'connecting'>
  updateCredits: (info: CreditInfo) => void
}
```

### Tauri Command Signatures

```typescript
// Phase 1 Rust stubs â€” Phase 2-B implements fully
invoke('get_config', { key: string }) => Promise<string>
invoke('set_config', { key: string, value: string }) => Promise<void>
invoke('resize_window', { width: number, height: number }) => Promise<void>
invoke('position_window', { x: number, y: number }) => Promise<void>
```

---

## Parallel Execution Plan

### Phase 1 â€” Scaffold + Contracts (1 agent, 1 day)

**Owns:** Everything. Creates the full structure with stubs.

Tasks:
1. Remove old Tauri v1 `tauri.conf.json` from crate root
2. Create `src-tauri/` with Tauri v2 `Cargo.toml` + `tauri.conf.json` (both windows configured)
3. Create `src-tauri/src/main.rs` with two windows + `Cmd+Shift+D` shortcut stub
4. Create `src-tauri/src/commands/` with stub implementations
5. Create `src-tauri/capabilities/default.json` + `entitlements.plist`
6. Create `package.json` + `vite.config.ts` (multi-entry)
7. Create `src/shared/types.ts` â€” full type definitions
8. Create `src/shared/styles/tokens.css` + `animations.css` â€” complete implementation
9. Create stub `.vue` files for all 8 shared components (typed props, empty template)
10. Create stub Pinia store files (exported types + empty `defineStore` bodies)
11. Create stub composable files
12. Create `src/App.vue` shell (imports FullMode/CopilotMode, mode-conditional render)
13. Create `src/NinjaApp.vue` shell (imports NinjaBar/NinjaDropdown)
14. Create `src/index.html` + `src/ninja.html`

**Exit gate:** `npm run build` produces two bundles (main + ninja) with zero errors.

---

### Phase 2 â€” Foundation (2 agents in parallel, 2 days)

**Agent A â€” Shared Components**
- Owns: `src/shared/components/**` only
- Implements all 8 components per spec Â§1.4 and DesignSystem_v3
- Each component: typed props, full CSS using tokens, correct visual states
- No store imports â€” use only props/emits
- Exit gate: each component renders correctly in isolation with stub props

**Agent B â€” Stores + IPC**
- Owns: `src/shared/stores/**`, `src/shared/composables/**`, `src-tauri/src/commands/**`
- Implements all 3 Pinia stores with full state + actions
- Implements `useAgentEvents` Tauri listener â†’ store dispatch
- Implements `useConfig` composable (config.toml r/w)
- Implements Rust commands: `get_config`, `set_config`, `resize_window`, `position_window`
- Exit gate: `invoke('set_config', ...)` writes to `~/.d1doctor/config.toml`; store unit tests pass

**Merge gate:** Both agents' branches squash-merged to `main` before Phase 3 starts.

---

### Phase 3 â€” Modes (3 agents in parallel, 2 days)

**Agent A â€” Full Mode**
- Owns: `src/modes/full/**` only
- Implements FullMode.vue, TitleBar.vue, Sidebar.vue, ChatWorkspace.vue, UtilityPanel.vue
- Imports shared components and stores â€” does not modify them
- All spec Â§2 acceptance criteria must pass
- Exit gate: renders correctly at 1200Ã—760; all 13 Full Mode acceptance criteria verified

**Agent B â€” Copilot Mode**
- Owns: `src/modes/copilot/**` only
- Implements CopilotMode.vue, CopilotHeader.vue, SessionBar.vue, CopilotInput.vue
- All spec Â§3 acceptance criteria must pass
- Exit gate: renders at 420px, draggable, position persists; all 7 Copilot criteria verified

**Agent C â€” Ninja Mode**
- Owns: `src/modes/ninja/**`, `src-tauri/src/main.rs` (Cmd+Shift+D implementation only)
- Implements NinjaBar.vue, NinjaDropdown.vue, StepTimeline.vue
- Implements global shortcut toggle in Rust main.rs
- All spec Â§4 acceptance criteria must pass
- Exit gate: `Cmd+Shift+D` toggles bar from other apps; slideDown animation; Esc handling; all 12 Ninja criteria verified

**Merge gate:** All three branches squash-merged to `main` before Phase 4.

---

### Phase 4 â€” Mode Switching (1 agent, 1 day)

- Owns: `src/App.vue`, `src/NinjaApp.vue`, `src/shared/stores/app.ts` (switchMode implementation)
- Wires `switchMode()` to Tauri window resize/reposition commands
- Tests all transition paths: Fullâ†”Copilot, anyâ†’Ninja, Ninjaâ†’any
- Verifies conversation state preservation across switches
- Verifies config.toml persistence and startup restore
- Exit gate: all 5 Mode Switching acceptance criteria pass

---

### Phase 5 â€” Agent Event Wiring (1 agent, 1 day)

- Owns: `src/shared/composables/useAgentEvents.ts`
- Connects all 8 event types to store mutations + component renders:
  - `plan_proposed` â†’ `conversationStore.setPlan()`
  - `step_started/completed/failed` â†’ `conversationStore.updateStep()`
  - `agent_message` â†’ `conversationStore.appendMessage()`
  - `result_ready` â†’ appends ResultCard to messages
  - `credits_updated` â†’ `agentStore.updateCredits()`
  - `permission_requested` â†’ appends PermissionBadge + toast
- Writes integration test harness that emits mock Tauri events and verifies store state
- Exit gate: all 8 event types update UI correctly; integration tests pass

---

## Key Engineering Notes

1. **Tauri transparent windows**: Both `transparent: true` in `tauri.conf.json` AND `.transparent(true)` in Rust builder are required. Missing either causes backdrop-filter to render against white.

2. **`-webkit-app-region: drag`**: Title bar container gets `drag`. All interactive children (traffic lights, inputs, buttons) must explicitly set `no-drag`.

3. **Global shortcut entitlement**: `com.apple.security.automation.apple-events` required in `entitlements.plist` for reliable macOS global shortcut operation.

4. **Two-window IPC**: Use `app.emit_to("ninja-bar", "agent_event", payload)` from Rust side when Ninja window is active. Both windows share the same Pinia store state via Tauri events (not Vue reactivity across windows).

5. **Config path**: `~/.d1doctor/config.toml`. Create directory + file on first launch if absent. Direct distribution (no Mac App Store sandbox) â€” `~/.d1doctor/` is accessible.

6. **Ninja window sizing strategy**: Use single expanding window (`setSize` API) rather than two separate windows. Simpler IPC, avoids z-order issues between bar and dropdown. Start at 64px height, expand to `64 + dropdown_content_height` on submit.

---

## Acceptance Criteria Reference

All criteria are in PRD spec Â§8. Summary counts:
- Full Mode: 13 criteria
- Copilot Mode: 7 criteria
- Ninja Mode: 12 criteria
- Mode Switching: 5 criteria
- Design System: 6 criteria
- **Total: 43 criteria** â€” all must pass before `ğŸ§ª Dev Testing` status

---

## Files NOT to Modify (Cross-Agent Rule)

Once Phase 1 creates them, these files are **read-only** for all downstream agents:

| File | Owner | Rule |
|------|-------|------|
| `src/shared/types.ts` | Phase 1 | Types are the contract â€” no changes |
| `src/shared/styles/tokens.css` | Phase 1 | Design tokens locked per spec Â§1.1 |
| `src/shared/styles/animations.css` | Phase 1 | Keyframes locked per spec Â§1.2 |
| `src/App.vue` | Phase 1/4 | Only Phase 4 agent modifies |
| `src/NinjaApp.vue` | Phase 1/4 | Only Phase 4 agent modifies |
| `src-tauri/tauri.conf.json` | Phase 1 | Config is spec-derived, no changes |
| `src-tauri/capabilities/default.json` | Phase 1 | Capabilities locked |
